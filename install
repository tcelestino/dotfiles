#!/usr/bin/env bash

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m'

# Get current location
DIR=$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)

log() {
  echo -e "${GREEN}[INFO]${NC} $1"
}

error() {
  echo -e "${RED}[ERROR]${NC} $1"
  exit 1
}

check_dependencies() {
  command -v brew >/dev/null 2>&1 || error "Homebrew is required but not installed. https://brew.sh/"
  command -v git >/dev/null 2>&1 || error "Git is required but not installed. https://git-scm.com/downloads"
}

safe_link() {
  local src="$1"
  local dest="$2"

  if [ -e "$dest" ] || [ -L "$dest" ]; then
      log "Found $dest - removing..."
      rm -f "$dest"
  fi

  if [ ! -e "$src" ]; then
      error "Source file $src does not exist!"
  fi

  log "Linking $dest to $src"
  ln -s "$src" "$dest"
}

safe_copy_dir() {
    local src="$1"
    local dest="$2"

    if [ ! -d "$src" ]; then
        error "Source directory $src does not exist!"
    fi

    if [ -d "$dest" ]; then
        log "Found $dest - removing..."
        rm -rf "$dest"
    fi

    log "Copying directory $src to $dest"
    if ! cp -R "$src" "$dest"; then
        error "Failed to copy directory $src to $dest"
    fi
}

install_oh_my_zsh() {
  if [ -d "$HOME/.oh-my-zsh" ]; then
      log "oh-my-zsh is already installed."
  else
      log "Installing oh-my-zsh..."
      if ! sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"; then
          error "Failed to install Deno"
      fi
  fi
}

install_deno() {
  if [ -d "$HOME/.deno/bin/deno" ]; then
    log "deno is already installed.."
  else
    log "Installing Deno"
    if ! sh -c "$(curl -fsSL https://deno.land/install.sh)"; then
      error "Failed to install oh-my-zsh"
    fi
  fi
}

setup_git() {
  safe_link "$DIR/git/.gitconfig" "$HOME/.gitconfig"
}

setup_zsh() {
  safe_link "$DIR/zsh/.zshrc" "$HOME/.zshrc"
  safe_link "$DIR/zsh/themes/dracula.zsh-theme" "$HOME/.oh-my-zsh/themes/dracula.zsh-theme"
  safe_link "$DIR/zsh/aliases.zsh" "$HOME/.oh-my-zsh/custom/aliases.zsh"
  safe_link "$DIR/zsh/custom-functions" "$HOME/.oh-my-zsh/plugins/custom-functions"
}

setup_npm() {
  safe_link "$DIR/.npmrc" "$HOME/.npmrc"

  # Install npm globally without sudo. Based on https://github.com/sindresorhus/guides/blob/main/npm-global-without-sudo.md
  if [ -d "$HOME/.npm-packages" ]; then
    log ".npm-packages folder exists"
  else
    mkdir -p "$HOME/.npm-packages"
  fi
}

npm_pkg() {
  if ! command -v node >/dev/null 2>&1; then
    error "Node.js is required but not installed. https://nodejs.org/"
  fi

  log "Installing global npm packages..."
  npm install -g git-cz # https://github.com/streamich/git-cz
}

setup_brew() {
  safe_link "$DIR/Brewfile" "$HOME/Brewfile"
  log "Executing brew bundle install..."
  if ! brew bundle install; then
      error "Brew bundle install failed"
  fi
}

setup_duti() {
  safe_link "$DIR/extras/duti_picview.config" "$HOME/duti_picview.config"
}

setup_fonts() {
  if [[ "$OSTYPE" == "darwin"* ]]; then
    # macOS
    local font_dir="$HOME/Library/Fonts"
    if [ ! -d "$font_dir" ]; then
      mkdir -p "$font_dir"
    fi
    log "Installing fonts for macOS..."
    cp "$DIR/fonts/"* "$font_dir/"
  elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
    # Ubuntu/Linux
    local font_dir="$HOME/.local/share/fonts"
    if [ ! -d "$font_dir" ]; then
      mkdir -p "$font_dir"
    fi
    log "Installing fonts for Linux..."
    cp "$DIR/fonts/"* "$font_dir/"
    fc-cache -f -v
  else
    error "Unsupported operating system"
  fi
}

setup_macos() {
  if [[ "$OSTYPE" == "darwin"* ]]; then
    log "Setting up macOS..."
    sh .macos
  fi
}

main() {
  log "Starting installation from $DIR..."

  check_dependencies

  install_oh_my_zsh
  install_deno

  setup_git
  setup_zsh
  setup_npm
  npm_pkg
  setup_brew
  setup_duti
  setup_fonts
  setup_macos

  log "Settings completed successfully! ðŸŽ‰"
}

main "$@"
